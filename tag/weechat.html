<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>weechat - cat | grep</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href="https://blog.catpipegrep.com/extra/favicon.ico" rel="icon">


    <meta name="author" content="Kevin Mancuso" />
    <meta name="keywords" content="weechat" />

    <!-- Open Graph tags -->
        <meta property="og:site_name" content="cat | grep" />
        <meta property="og:type" content="website"/>
        <meta property="og:title" content="cat | grep"/>
        <meta property="og:url" content="https://blog.catpipegrep.com"/>
        <meta property="og:description" content="cat | grep"/>


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://blog.catpipegrep.com/theme/css/bootstrap.superhero.min.css" type="text/css"/>
    <link href="https://blog.catpipegrep.com/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://blog.catpipegrep.com/theme/css/pygments/native.css" rel="stylesheet">
        <link href="https://blog.catpipegrep.com/theme/css/html4css1.css" rel="stylesheet">
        <link href="https://blog.catpipegrep.com/theme/css/typogrify.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blog.catpipegrep.com/theme/css/style.css" type="text/css"/>

        <link href="https://blog.catpipegrep.com/atom.xml" type="application/atom+xml" rel="alternate"
              title="cat | grep ATOM Feed"/>




</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://blog.catpipegrep.com/" class="navbar-brand">
cat | grep            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="/pages/about/">About</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-lg-12">
            <article>
                <h2><a href="https://blog.catpipegrep.com/posts/2016/07/08/getting-started-letsencrypt/">Getting started with&nbsp;LetsEncrypt</a></h2>
                    <div class="well well-sm">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2016-07-08T22:19:22-05:00"> Fri 08 July 2016</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://blog.catpipegrep.com/tag/letsencrypt.html">letsencrypt</a>
        /
	<a href="https://blog.catpipegrep.com/tag/ansible.html">ansible</a>
        /
	<a href="https://blog.catpipegrep.com/tag/subsonic.html">subsonic</a>
        /
	<a href="https://blog.catpipegrep.com/tag/weechat.html">weechat</a>
    
</footer><!-- /.post-info -->                    </div>
                <div class="summary"><p><a class="reference external" href="https://letsencrypt.org/">LetsEncrypt</a> really changed the <span class="caps">SSL</span> game, offering free certificates, but more than that offering them in a programatic way thus paving the way for a decent automation story. However the official client, now known as <a class="reference external" href="https://certbot.eff.org/">certbot</a>, is lacking on certain features. Luckily there are a slew of clients that speak the <a class="reference external" href="https://ietf-wg-acme.github.io/acme/"><span class="caps">ACME</span></a> protocol. After fiddling around with a few clients I wound up settling on a client written in Go named <a class="reference external" href="https://github.com/xenolf/lego">Lego</a>.</p>
<div class="section" id="obtaining-the-cert">
<h2><a class="reference internal" href="#obtaining-the-cert">Obtaining the&nbsp;cert</a></h2>
<p>I wanted a central location to manage my certificate lifecycle as well as having a single repository to handle the orchestration of the deployment of such certificates. As such, the default mechanism of dropping a challenge file in a webroot wouldn&#8217;t work, as well as a few of the things I run don&#8217;t lend itself to such an auth mechanism. In favor of this, I decided to leverage <a class="reference external" href="https://ietf-wg-acme.github.io/acme/#rfc.section.7.4">dns-01</a>&nbsp;instead.</p>
<p>I like things tidy, so I keep everything inside of a directory structure as follows in <tt class="docutils literal">/opt/</tt>:</p>
<pre class="literal-block">
lego
├── ansible // Where I keep the installation automation playbooks
│&nbsp;&nbsp; └── roles
│&nbsp;&nbsp;     ├── host1
│&nbsp;&nbsp;     │&nbsp;&nbsp; ├── files
│&nbsp;&nbsp;     │&nbsp;&nbsp; ├── handlers
│&nbsp;&nbsp;     │&nbsp;&nbsp; └── tasks
│&nbsp;&nbsp;     ├── host2
│&nbsp;&nbsp;     │&nbsp;&nbsp; ├── files
│&nbsp;&nbsp;     │&nbsp;&nbsp; ├── handlers
│&nbsp;&nbsp;     │&nbsp;&nbsp; └── tasks
│&nbsp;&nbsp;     └── host3
│&nbsp;&nbsp;         ├── files
│&nbsp;&nbsp;         ├── handlers
│&nbsp;&nbsp;         └── tasks
├── bin // Lego bin lives here and misc scripts
└── data // Where Lego writes its goods
    ├── accounts
        │&nbsp;&nbsp; └── acme-v01.api.letsencrypt.org
            │&nbsp;&nbsp;     └── email&#64;example.com
                │&nbsp;&nbsp;         └── keys
                    └── certificates // Here be certs
</pre>
<p>Since I am using the <tt class="docutils literal"><span class="pre">dns-01</span></tt> challenge with <span class="caps">AWS</span> Route53, the following environment variables must be defined: <tt class="docutils literal">AWS_ACCESS_KEY_ID</tt> and <tt class="docutils literal">AWS_SECRET_ACCESS_KEY</tt>. Ensure there is a proper <span class="caps">IAM</span> role defined for this task, as well a corresponding policy. The Lego <span class="caps">README</span> provides an example policy which will get you&nbsp;going:</p>
<pre class="literal-block">
{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: [
                &quot;route53:GetChange&quot;,
                &quot;route53:ListHostedZonesByName&quot;
            ],
            &quot;Resource&quot;: [
                &quot;*&quot;
            ]
        },
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: [
                &quot;route53:ChangeResourceRecordSets&quot;
            ],
            &quot;Resource&quot;: [
                &quot;arn:aws:route53:::hostedzone/&lt;INSERT_YOUR_HOSTED_ZONE_ID_HERE&gt;&quot;
            ]
        }
    ]
}
</pre>
<p>If you have multiple domains, in the second resource block just add a second <span class="caps">ARN</span> in a comma separated list. Or if you are less particular in doing things right and want to be looser on security, add <tt class="docutils literal"><span class="pre">arn:aws:route53:::hostedzone/*</span></tt> to allow modifications to all&nbsp;domains.</p>
<p>With that done, we can finally get our certs! This is as simple&nbsp;as:</p>
<pre class="literal-block">
AWS_ACCESS_KEY_ID=&quot;&lt;accessid&gt;&quot; AWS_SECRET_ACCESS_KEY=&quot;&lt;secretkey&gt;&quot; /opt/lego/bin/lego -a --path=&quot;/opt/lego/data/&quot; --email=&quot;email&#64;example.com&quot; --domain=&quot;domain.com&quot; --dns route53 run
</pre>
<dl class="docutils">
<dt>Arguments&nbsp;are:</dt>
<dd><table class="first last docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group">
<kbd><span class="option">-a</span></kbd></td>
<td>Acknowledges that you agree to the current LetsEncrypt terms of service</td></tr>
<tr><td class="option-group">
<kbd><span class="option">--path</span></kbd></td>
<td>Where to stick the certs and account information</td></tr>
<tr><td class="option-group">
<kbd><span class="option">--email</span></kbd></td>
<td>The identity you want to use to register the cert with, they send you things like expiration notices</td></tr>
<tr><td class="option-group">
<kbd><span class="option">--domain</span></kbd></td>
<td>The domain you want to get the cert for</td></tr>
<tr><td class="option-group">
<kbd><span class="option">--dns</span></kbd></td>
<td>Specifies the <span class="caps">DNS</span> challenge, in this case route 53</td></tr>
</tbody>
</table>
</dd>
</dl>
<p>You will notice that it both creates the <span class="caps">DNS</span> resource record to satisfy the challenge, and if everything went swimmingly will cleanup said record leaving things nice and&nbsp;tidy.</p>
</div>
<div class="section" id="renewing-the-certs">
<h2><a class="reference internal" href="#renewing-the-certs">Renewing the&nbsp;certs</a></h2>
<p>With the cert obtained, we need to ensure that the certs get renewed with the standard 90 day life of a LetsEncrypt certificate. This is as simple as changing <tt class="docutils literal">run</tt> to <tt class="docutils literal">renew</tt> and adding <tt class="docutils literal"><span class="pre">--days</span> 30</tt> to renew it within 30 days of&nbsp;expiration.</p>
<p>But since we want to automate this, lets make a little script to do this for&nbsp;us:</p>
<pre class="literal-block">
#!/bin/bash

DOMAINS=&quot;example.com example.org example.net&quot;&quot;
AWS_ACCESS_KEY_ID=&quot;&lt;access_key&gt;&quot;
AWS_SECRET_ACCESS_KEY=&quot;&lt;secret_key&gt;&quot;

for domain in $DOMAINS; do
    /opt/lego/bin/lego -a --path=&quot;/opt/lego/data/&quot; --email=&quot;email&#64;example.com&quot; --domains=&quot;$domain&quot; --dns route53 renew --days 30
    done
</pre>
<p>This will iterate through the list of <tt class="docutils literal">$<span class="caps">DOMAINS</span></tt> and will renew each one. I threw this in a cronjob to run every night, but a systemd timer is nice too if you swing that&nbsp;way.</p>
</div>
<div class="section" id="installing-the-certs">
<h2><a class="reference internal" href="#installing-the-certs">Installing the&nbsp;certs</a></h2>
<p>There probably is a more elegant way of approaching this, but Ansible seemed perfect for what is being done here. It will ensure the certs are placed on the remote servers, and will execute actions if an update has happened and will noop otherwise. A basic boilerplate requires your <a class="reference external" href="http://docs.ansible.com/ansible/intro_inventory.html">inventory</a> defined, I call mine <cite>hosts.ini</cite>. In my playbook I define each host as a role to customize how each server needs to be handled. My playbook <tt class="docutils literal">certificates.yaml</tt> looks as&nbsp;follows:</p>
<pre class="literal-block">
- hosts: host1
  sudo: yes
  roles:
      - {role: 'roles/host1'}
</pre>
<p>Inside of each role&#8217;s <tt class="docutils literal">files</tt> directory I then symlink the cert and key in <tt class="docutils literal">/opt/lego/data/certificates/</tt> and define the specific installation plays in <tt class="docutils literal">tasks</tt>.</p>
<p>Once your playbook looks and acts reasonably, cron it&nbsp;out:</p>
<pre class="literal-block">
ansible-playbook -i /opt/lego/ansible/hosts.ini /opt/lego/ansible/certificates.yaml &gt; /dev/null
</pre>
<div class="section" id="installation-for-subsonic">
<h3><a class="reference internal" href="#installation-for-subsonic">Installation for&nbsp;Subsonic</a></h3>
<p>Since <a class="reference external" href="http://subsonic.org">Subsonic</a> runs java, we have to deal with the goofy keytool shenanigans. So the task I have defined for this server&nbsp;resembles:</p>
<pre class="literal-block">
---
- name: Install certs
  copy: src={{ item }} dest=/opt/subsonic/ssl/{{ item }} mode=0600
  with_items:
      - subsonic.example.com.crt
      - subsonic.example.com.key
  notify:
      - generate keystore
      - restart subsonic
</pre>
<p>With a <tt class="docutils literal">handler</tt> definition resembling the&nbsp;following:</p>
<pre class="literal-block">
- name: generate keystore
  shell: /opt/subsonic/ssl/keytool.sh

- name: restart subsonic
  service: name=subsonic state=restarted
</pre>
<p>keytool.sh is just a simple incarnation of the commands to convert the pems into the format that java is happy&nbsp;with:</p>
<pre class="literal-block">
#!/bin/bash

/usr/bin/openssl pkcs12 -in /opt/subsonic/ssl/subsonic.example.com.crt -inkey /opt/subsonic/ssl/subsonic.example.com.key key -export -out /opt/subsonic/ssl/subsonic.pkcs12 -password pass:subsonic

/usr/bin/keytool -importkeystore -srckeystore /opt/subsonic/ssl/subsonic.pkcs12 -destkeystore /opt/subsonic/ssl/subsonic.keystore -srcstoretype PKCS12 -srcstorepass subsonic -deststorepass subsonic -srcalias 1 -destalias subsonic

/usr/bin/zip -j /opt/subsonic/subsonic-booter-jar-with-dependencies.jar /opt/subsonic/ssl/subsonic.keystore

/bin/rm /opt/subsonic/ssl/subsonic.keystore /opt/subsonic/ssl/subsonic.pkcs12
</pre>
</div>
<div class="section" id="installation-for-weechat">
<h3><a class="reference internal" href="#installation-for-weechat">Installation for&nbsp;weechat</a></h3>
<p>The very capable <span class="caps">IRC</span> client <a class="reference external" href="https://weechat.org/">weechat</a> has a relay protocol allowing for remote access to the client from other things, such as a mobile browser such as <a class="reference external" href="https://www.glowing-bear.org/">Glowing Bear</a> which I use to access <span class="caps">IRC</span> from my iOS&nbsp;devices.</p>
<p>This assumes weechat relay is already set up, to start encrypting programatically we need a task defined similiar&nbsp;to:</p>
<pre class="literal-block">
- name: Install certs for weechat
  copy: src={{ item }} dest=/home/taco/.weechat/certs/{{ item }} mode=600
  with_items:
      - weechat.example.com.crt
      - weechat.example.com.key
  notify:
      - reload weechat certs
</pre>
<p>And a handler such&nbsp;as:</p>
<pre class="literal-block">
- name: reload weechat certs
  shell: /home/taco/.weechat/reloadcert.sh
</pre>
<p>Since <tt class="docutils literal">reloadcert.sh</tt> will send a <tt class="docutils literal">/relay sslcertkey</tt> via the fifo channel, ensure your weechat has it enabled with <tt class="docutils literal">plugins.var.fifo.fifo = on</tt>. If it&#8217;s on inside your <tt class="docutils literal">.weechat</tt> directory you will find a file resembling <tt class="docutils literal">weechat_fifo_123</tt> with the suffix numbers indicating&nbsp;pid.</p>
<pre class="literal-block">
#!/bin/bash

cat /home/taco/.weechat/certs/weechat.example.com.key /home/taco/.weechat/certs/weechat.example.com.crt &gt; /home/taco/.weechat/certs/relay.pem
for fifo in /home/taco/.weechat/weechat_fifo_*
do
    printf '%b' '*/relay sslcertkey\n' &gt; &quot;$fifo&quot;
done
</pre>
<p>This will send the reload to all running weechat instances, but is mostly harmless if the certpaths are configured&nbsp;correctly.</p>
</div>
</div>

                    <a class="btn btn-default btn-xs" href="https://blog.catpipegrep.com/posts/2016/07/08/getting-started-letsencrypt/">more ...</a>
                </div>
            </article>
            <hr/>

        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2016 Kevin Mancuso
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://blog.catpipegrep.com/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://blog.catpipegrep.com/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://blog.catpipegrep.com/theme/js/respond.min.js"></script>

    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'catpipegrep'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-47947008-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

</body>
</html>